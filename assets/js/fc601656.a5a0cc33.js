"use strict";(self.webpackChunkepilot_dev_handbook=self.webpackChunkepilot_dev_handbook||[]).push([[43087],{35722:(e,t,n)=>{n.d(t,{G:()=>p});var a=n(42858),i=n(67294),l=n(25108);let r=0,o=!1;const d=(e,t)=>{const n=e?.getAttribute("data-theme")??"light",a="dark"===n?"dark":"default";return t?.theme?.[n]??t?.mermaid?.theme??a},p=e=>{let{chart:t,config:n}=e;const p=(0,i.useRef)(null),s=(0,i.useRef)("mermaid-"+r++),[u,m]=(0,i.useState)(""),c=(0,i.useMemo)((()=>"string"==typeof n?JSON.parse(n):n),[n]);return(0,i.useEffect)((()=>{if("undefined"==typeof window)return;const e=document.querySelector("html"),n=d(e,c);o||(a.Z.initialize({startOnLoad:!1,theme:n,...c?.mermaid||{}}),o=!0);(async()=>{try{const{svg:e}=await a.Z.render(s.current,t);m(e)}catch(e){l.error("Mermaid rendering failed:",e)}})()}),[t,c]),(0,i.useEffect)((()=>{if("undefined"==typeof window)return;const e=document.querySelector("html"),n=new MutationObserver((n=>{for(const i of n){if("attributes"!==i.type||"data-theme"!==i.attributeName)continue;const n=d(e,c);o=!1,a.Z.initialize({startOnLoad:!1,theme:n,...c?.mermaid||{}}),o=!0,s.current="mermaid-"+r++,a.Z.render(s.current,t).then((e=>{let{svg:t}=e;m(t)}));break}}));return n.observe(e,{attributes:!0}),()=>n.disconnect()}),[t,c]),"undefined"==typeof window?i.createElement("div",{className:"mermaid"},t):i.createElement("div",{ref:p,dangerouslySetInnerHTML:{__html:u}})}},96008:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>r,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>d});var a=n(87462),i=(n(67294),n(3905));n(35722);const l={sidebar_position:2,title:"Mapping",description:"Configure how ERP data transforms into epilot entities"},r="Mapping",o={unversionedId:"integrations/erp-toolkit/inbound/mapping",id:"integrations/erp-toolkit/inbound/mapping",title:"Mapping",description:"Configure how ERP data transforms into epilot entities",source:"@site/docs/integrations/erp-toolkit/inbound/mapping.md",sourceDirName:"integrations/erp-toolkit/inbound",slug:"/integrations/erp-toolkit/inbound/mapping",permalink:"/docs/integrations/erp-toolkit/inbound/mapping",editUrl:"https://github.com/epilot-dev/docs/edit/main/docs/integrations/erp-toolkit/inbound/mapping.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,title:"Mapping",description:"Configure how ERP data transforms into epilot entities"},sidebar:"docsSidebar",previous:{title:"Getting Started",permalink:"/docs/integrations/erp-toolkit/inbound/getting-started"},next:{title:"Unique Identifiers",permalink:"/docs/integrations/erp-toolkit/inbound/unique-identifiers"}},d=[{value:"Mapping Configuration",id:"mapping-configuration",children:[{value:"Entity Properties",id:"entity-properties",children:[],level:3}],level:2},{value:"Field Mapping Types",id:"field-mapping-types",children:[{value:"Direct Field Mapping",id:"direct-field-mapping",children:[],level:3},{value:"Nested Field Access (JSONPath)",id:"nested-field-access-jsonpath",children:[],level:3},{value:"JSONata Expressions",id:"jsonata-expressions",children:[],level:3},{value:"Constant Values",id:"constant-values",children:[],level:3},{value:"Enabled Field",id:"enabled-field",children:[],level:3},{value:"File Proxy URL Mapping",id:"file-proxy-url-mapping",children:[],level:3}],level:2},{value:"Repeatable Fields",id:"repeatable-fields",children:[{value:"Email Fields",id:"email-fields",children:[],level:3},{value:"Phone Fields",id:"phone-fields",children:[],level:3}],level:2},{value:"Entity-Level JSONata",id:"entity-level-jsonata",children:[],level:2},{value:"Multiple Entities",id:"multiple-entities",children:[],level:2},{value:"Dynamic Entity Expansion",id:"dynamic-entity-expansion",children:[],level:2},{value:"Conditional Entity Processing",id:"conditional-entity-processing",children:[],level:2},{value:"Operation Modes",id:"operation-modes",children:[{value:"Mode Options",id:"mode-options",children:[],level:3},{value:"Entity Deletion",id:"entity-deletion",children:[{value:"Conditional Deletion",id:"conditional-deletion",children:[],level:4}],level:3},{value:"Prune Scope Operations",id:"prune-scope-operations",children:[{value:"Scope Configuration",id:"scope-configuration",children:[{value:"scope_mode Options",id:"scope_mode-options",children:[],level:5}],level:4},{value:"Example: Sync Billing Events for a Billing Account",id:"example-sync-billing-events-for-a-billing-account",children:[],level:4},{value:"Example: Query Mode for Direct Matching",id:"example-query-mode-for-direct-matching",children:[],level:4}],level:3},{value:"Meter Reading Prune Scope Operations",id:"meter-reading-prune-scope-operations",children:[{value:"Scope Configuration (optional)",id:"scope-configuration-optional",children:[],level:4},{value:"Example: Basic Meter Reading Prune Scope",id:"example-basic-meter-reading-prune-scope",children:[],level:4},{value:"Example: With Source Scope",id:"example-with-source-scope",children:[],level:4},{value:"Important Notes",id:"important-notes",children:[],level:4}],level:3},{value:"Mixed Operations",id:"mixed-operations",children:[],level:3}],level:2},{value:"Field Mapping Priority",id:"field-mapping-priority",children:[],level:2},{value:"Array Attribute Operations",id:"array-attribute-operations",children:[{value:"Set (<code>_set</code>)",id:"set-_set",children:[],level:3},{value:"Append (<code>_append</code>)",id:"append-_append",children:[],level:3},{value:"Append All (<code>_append_all</code>)",id:"append-all-_append_all",children:[],level:3}],level:2},{value:"Best Practices",id:"best-practices",children:[{value:"Use Meaningful Unique IDs",id:"use-meaningful-unique-ids",children:[],level:3},{value:"Handle Optional Fields",id:"handle-optional-fields",children:[],level:3},{value:"Validate Data with JSONata",id:"validate-data-with-jsonata",children:[],level:3}],level:2},{value:"Next Steps",id:"next-steps",children:[],level:2}],p={toc:d},s="wrapper";function u(e){let{components:t,...n}=e;return(0,i.kt)(s,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"mapping"},"Mapping"),(0,i.kt)("p",null,"Mapping defines how ERP data transforms into epilot entities. This page covers the configuration structure and available options."),(0,i.kt)("h2",{id:"mapping-configuration"},"Mapping Configuration"),(0,i.kt)("p",null,"A mapping configuration consists of one or more entity definitions:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="Mapping configuration"',title:'"Mapping','configuration"':!0},'{\n  "entities": [\n    {\n      "entity_schema": "contact",\n      "unique_ids": ["customer_number"],\n      "enabled": true,\n      "fields": [...]\n    }\n  ]\n}\n')),(0,i.kt)("h3",{id:"entity-properties"},"Entity Properties"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Property"),(0,i.kt)("th",{parentName:"tr",align:null},"Type"),(0,i.kt)("th",{parentName:"tr",align:null},"Required"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"entity_schema")),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"Yes"),(0,i.kt)("td",{parentName:"tr",align:null},"The epilot entity schema (e.g., ",(0,i.kt)("inlineCode",{parentName:"td"},"contact"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"contract"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"meter"),")")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"unique_ids")),(0,i.kt)("td",{parentName:"tr",align:null},"string[]"),(0,i.kt)("td",{parentName:"tr",align:null},"Yes"),(0,i.kt)("td",{parentName:"tr",align:null},"Fields used to find existing entities")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"enabled")),(0,i.kt)("td",{parentName:"tr",align:null},"boolean/string"),(0,i.kt)("td",{parentName:"tr",align:null},"No"),(0,i.kt)("td",{parentName:"tr",align:null},"Enable/disable this mapping")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"mode")),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"No"),(0,i.kt)("td",{parentName:"tr",align:null},"Operation mode: ",(0,i.kt)("inlineCode",{parentName:"td"},"upsert")," (default), ",(0,i.kt)("inlineCode",{parentName:"td"},"delete"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"purge"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"upsert-prune-scope-purge"),", or ",(0,i.kt)("inlineCode",{parentName:"td"},"upsert-prune-scope-delete"),". See ",(0,i.kt)("a",{parentName:"td",href:"#operation-modes"},"Operation Modes"),". For meter readings, see also ",(0,i.kt)("inlineCode",{parentName:"td"},"upsert-prune-scope")," in ",(0,i.kt)("a",{parentName:"td",href:"#meter-reading-prune-scope-operations"},"Meter Reading Prune Scope Operations"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"scope")),(0,i.kt)("td",{parentName:"tr",align:null},"object"),(0,i.kt)("td",{parentName:"tr",align:null},"No"),(0,i.kt)("td",{parentName:"tr",align:null},"Required for prune-scope modes. Defines which entities to consider for pruning. See ",(0,i.kt)("a",{parentName:"td",href:"#prune-scope-operations"},"Prune Scope Operations"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"jsonataExpression")),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"No"),(0,i.kt)("td",{parentName:"tr",align:null},"Pre-process the payload before field mapping")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"fields")),(0,i.kt)("td",{parentName:"tr",align:null},"array"),(0,i.kt)("td",{parentName:"tr",align:null},"Yes"),(0,i.kt)("td",{parentName:"tr",align:null},"Field mapping definitions")))),(0,i.kt)("h2",{id:"field-mapping-types"},"Field Mapping Types"),(0,i.kt)("h3",{id:"direct-field-mapping"},"Direct Field Mapping"),(0,i.kt)("p",null,"Map a source field directly to a target attribute:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attribute": "first_name",\n  "field": "firstName"\n}\n')),(0,i.kt)("h3",{id:"nested-field-access-jsonpath"},"Nested Field Access (JSONPath)"),(0,i.kt)("p",null,"Access nested data using JSONPath syntax with ",(0,i.kt)("inlineCode",{parentName:"p"},"$")," prefix:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attribute": "street",\n  "field": "$.address.street"\n}\n')),(0,i.kt)("h3",{id:"jsonata-expressions"},"JSONata Expressions"),(0,i.kt)("p",null,"Use JSONata for complex transformations:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attribute": "full_name",\n  "jsonataExpression": "firstName & \' \' & lastName"\n}\n')),(0,i.kt)("p",null,"Common JSONata patterns:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},"// Concatenation\n\"firstName & ' ' & lastName\"\n\n// Conditional\n\"$exists(middleName) ? firstName & ' ' & middleName & ' ' & lastName : firstName & ' ' & lastName\"\n\n// Date formatting\n\"$fromMillis($toMillis(dateField), '[Y]-[M01]-[D01]')\"\n\n// Array access\n\"addresses[0].street\"\n\n// Filtering\n\"items[status = 'active']\"\n")),(0,i.kt)("h3",{id:"constant-values"},"Constant Values"),(0,i.kt)("p",null,"Set a fixed value:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attribute": "source",\n  "constant": "SAP"\n}\n')),(0,i.kt)("h3",{id:"enabled-field"},"Enabled Field"),(0,i.kt)("p",null,"Use the ",(0,i.kt)("inlineCode",{parentName:"p"},"enabled")," property to conditionally map fields:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attribute": "phone",\n  "field": "phoneNumber",\n  "enabled": "$exists(phoneNumber) and phoneNumber != \'\'"\n}\n')),(0,i.kt)("h3",{id:"file-proxy-url-mapping"},"File Proxy URL Mapping"),(0,i.kt)("p",null,"When syncing file entities via inbound use cases, you can use the ",(0,i.kt)("inlineCode",{parentName:"p"},"file_proxy_url")," field type to auto-construct the file proxy download URL. This avoids manually assembling the URL with boilerplate query parameters \u2014 ",(0,i.kt)("inlineCode",{parentName:"p"},"orgId")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"integrationId")," are injected automatically from the processing context."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Configuration:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attribute": "custom_download_url",\n  "file_proxy_url": {\n    "use_case_id": "uuid-of-file-proxy-use-case",\n    "params": {\n      "documentId": { "field": "documentId" },\n      "tenantId": { "constant": "ACME" }\n    }\n  }\n}\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Input:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "documentId": "DOC-00034157"\n}\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Output:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attributes": {\n    "custom_download_url": "https://erp-file-proxy.sls.epilot.io/download?orgId=123&integrationId=abc&useCaseId=uuid-of-file-proxy-use-case&documentId=DOC-00034157&tenantId=ACME"\n  }\n}\n')),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"params")," object maps URL parameter names to values resolved from the payload. Each param value supports three resolution modes:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Mode"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"),(0,i.kt)("th",{parentName:"tr",align:null},"Example"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"field")),(0,i.kt)("td",{parentName:"tr",align:null},"Source field name or JSONPath expression (if starts with ",(0,i.kt)("inlineCode",{parentName:"td"},"$"),")"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},'{ "field": "documentId" }'))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"constant")),(0,i.kt)("td",{parentName:"tr",align:null},"Fixed value (any type, stringified for URL)"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},'{ "constant": "ACME" }'))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"jsonataExpression")),(0,i.kt)("td",{parentName:"tr",align:null},"JSONata expression for transformation"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},'{ "jsonataExpression": "doc.id" }'))))),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"Note:")," The standard parameters ",(0,i.kt)("inlineCode",{parentName:"p"},"orgId"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"integrationId"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},"useCaseId")," are always included automatically. You only need to configure additional custom parameters in ",(0,i.kt)("inlineCode",{parentName:"p"},"params"),". If no ",(0,i.kt)("inlineCode",{parentName:"p"},"integrationContext")," is available (e.g., in mapping simulation mode), the ",(0,i.kt)("inlineCode",{parentName:"p"},"file_proxy_url")," field is silently skipped.")),(0,i.kt)("p",null,"See also: ",(0,i.kt)("a",{parentName:"p",href:"../file-proxy#proxy-url-generation"},"File Proxy Configuration")," for details on the proxy URL format and parameter requirements."),(0,i.kt)("h2",{id:"repeatable-fields"},"Repeatable Fields"),(0,i.kt)("p",null,"Email and phone fields in epilot are stored as arrays. Use ",(0,i.kt)("inlineCode",{parentName:"p"},"_type")," to specify the field type:"),(0,i.kt)("h3",{id:"email-fields"},"Email Fields"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attribute": "email",\n  "field": "emailAddress",\n  "_type": "email"\n}\n')),(0,i.kt)("p",null,"This transforms the input value into the epilot format:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'// Input\n{ "emailAddress": "john@example.com" }\n\n// Output in epilot\n{ "email": [{ "email": "john@example.com" }] }\n')),(0,i.kt)("h3",{id:"phone-fields"},"Phone Fields"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attribute": "phone",\n  "field": "phoneNumber",\n  "_type": "phone"\n}\n')),(0,i.kt)("h2",{id:"entity-level-jsonata"},"Entity-Level JSONata"),(0,i.kt)("p",null,"Pre-process the entire payload before field mapping:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "entity_schema": "contact",\n  "jsonataExpression": "$merge([payload, {\'fullAddress\': payload.street & \', \' & payload.city}])",\n  "unique_ids": ["customer_number"],\n  "fields": [\n    { "attribute": "address_display", "field": "fullAddress" }\n  ]\n}\n')),(0,i.kt)("h2",{id:"multiple-entities"},"Multiple Entities"),(0,i.kt)("p",null,"Process multiple entities from a single event:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "entities": [\n    {\n      "entity_schema": "contact",\n      "unique_ids": ["customer_number"],\n      "fields": [\n        { "attribute": "customer_number", "field": "customerId" },\n        { "attribute": "first_name", "field": "firstName" },\n        { "attribute": "last_name", "field": "lastName" }\n      ]\n    },\n    {\n      "entity_schema": "account",\n      "unique_ids": ["account_number"],\n      "fields": [\n        { "attribute": "account_number", "field": "accountId" },\n        { "attribute": "name", "field": "companyName" }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("h2",{id:"dynamic-entity-expansion"},"Dynamic Entity Expansion"),(0,i.kt)("p",null,"Create multiple entities from an array in the payload:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "entity_schema": "meter",\n  "jsonataExpression": "meters",\n  "unique_ids": ["meter_number"],\n  "fields": [\n    { "attribute": "meter_number", "field": "meterId" },\n    { "attribute": "type", "field": "meterType" }\n  ]\n}\n')),(0,i.kt)("p",null,"Given this input:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meters": [\n    { "meterId": "M001", "meterType": "electricity" },\n    { "meterId": "M002", "meterType": "gas" }\n  ]\n}\n')),(0,i.kt)("p",null,"This creates two meter entities."),(0,i.kt)("h2",{id:"conditional-entity-processing"},"Conditional Entity Processing"),(0,i.kt)("p",null,"Enable or disable entity processing based on payload conditions:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "entity_schema": "contact",\n  "enabled": "customerType = \'individual\'",\n  "unique_ids": ["customer_number"],\n  "fields": [...]\n}\n')),(0,i.kt)("h2",{id:"operation-modes"},"Operation Modes"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"mode")," field controls how entities are processed. By default, entities are upserted (created or updated)."),(0,i.kt)("h3",{id:"mode-options"},"Mode Options"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Mode"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"upsert")),(0,i.kt)("td",{parentName:"tr",align:null},"Create or update the entity (default behavior)")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"delete")),(0,i.kt)("td",{parentName:"tr",align:null},"Soft delete - marks entity as deleted but keeps in Recycle Bin for 30 days")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"purge")),(0,i.kt)("td",{parentName:"tr",align:null},"Hard delete - permanently removes from the system")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"upsert-prune-scope-purge")),(0,i.kt)("td",{parentName:"tr",align:null},"Upsert entities from array, then hard delete entities in scope that weren't upserted")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"upsert-prune-scope-delete")),(0,i.kt)("td",{parentName:"tr",align:null},"Upsert entities from array, then soft delete entities in scope that weren't upserted")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"upsert-prune-scope")),(0,i.kt)("td",{parentName:"tr",align:null},"(Meter readings only) Upsert readings from array, then delete all other readings for the same meter+counter that weren't upserted")))),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"upsert-prune-scope-*")," modes require a ",(0,i.kt)("inlineCode",{parentName:"p"},"scope")," configuration. See ",(0,i.kt)("a",{parentName:"p",href:"#prune-scope-operations"},"Prune Scope Operations"),". The ",(0,i.kt)("inlineCode",{parentName:"p"},"upsert-prune-scope")," mode is for meter readings only and uses the meter+counter as natural scope. See ",(0,i.kt)("a",{parentName:"p",href:"#meter-reading-prune-scope-operations"},"Meter Reading Prune Scope Operations"),"."))),(0,i.kt)("h3",{id:"entity-deletion"},"Entity Deletion"),(0,i.kt)("p",null,"To delete entities, use ",(0,i.kt)("inlineCode",{parentName:"p"},'mode: "delete"')," or ",(0,i.kt)("inlineCode",{parentName:"p"},'mode: "purge"'),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "entities": [\n    {\n      "entity_schema": "billing_event",\n      "unique_ids": ["external_id"],\n      "mode": "purge",\n      "fields": [\n        {\n          "attribute": "external_id",\n          "field": "billing_event_id"\n        }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("p",null,"For deletion modes, only the ",(0,i.kt)("inlineCode",{parentName:"p"},"unique_ids")," fields need to be mapped in ",(0,i.kt)("inlineCode",{parentName:"p"},"fields")," - other field mappings are ignored since no entity attributes are being updated."),(0,i.kt)("h4",{id:"conditional-deletion"},"Conditional Deletion"),(0,i.kt)("p",null,"Combine ",(0,i.kt)("inlineCode",{parentName:"p"},"mode")," with ",(0,i.kt)("inlineCode",{parentName:"p"},"enabled")," for conditional deletion based on payload data:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "entity_schema": "contract",\n  "unique_ids": ["contract_number"],\n  "mode": "delete",\n  "enabled": "status = \'TERMINATED\'",\n  "fields": [\n    { "attribute": "contract_number", "field": "contract_id" }\n  ]\n}\n')),(0,i.kt)("h3",{id:"prune-scope-operations"},"Prune Scope Operations"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"upsert-prune-scope-purge")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"upsert-prune-scope-delete")," modes upsert all entities from an array in the payload, then delete/purge entities within a defined scope that weren't included in the upsert."),(0,i.kt)("p",null,"This is ideal for synchronizing child entity collections, such as billing events for a billing account."),(0,i.kt)("h4",{id:"scope-configuration"},"Scope Configuration"),(0,i.kt)("p",null,"Prune-scope modes require a ",(0,i.kt)("inlineCode",{parentName:"p"},"scope")," configuration that defines which existing entities are eligible for deletion. The scope resolves against the ",(0,i.kt)("strong",{parentName:"p"},"original event payload")," (not individual array items)."),(0,i.kt)("h5",{id:"scope_mode-options"},"scope_mode Options"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Mode"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"relations")),(0,i.kt)("td",{parentName:"tr",align:null},"Find scope by looking at all entities related to a specific entity (both direct and reverse relations)")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"query")),(0,i.kt)("td",{parentName:"tr",align:null},"Find scope entities directly via query parameters")))),(0,i.kt)("h4",{id:"example-sync-billing-events-for-a-billing-account"},"Example: Sync Billing Events for a Billing Account"),(0,i.kt)("p",null,"Sync all billing events for a billing account and remove any that are no longer in the payload:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "entities": [\n    {\n      "entity_schema": "billing_event",\n      "unique_ids": ["external_id"],\n      "jsonataExpression": "$map(billingevents[], function($v) { $merge([$v, { \\"billingaccountnumber\\": billingaccountnumber }]) })",\n      "mode": "upsert-prune-scope-purge",\n      "scope": {\n        "scope_mode": "relations",\n        "schema": "billing_account",\n        "unique_ids": [\n          {\n            "attribute": "billing_account_number",\n            "field": "billingaccountnumber"\n          }\n        ]\n      },\n      "fields": [\n        { "attribute": "external_id", "field": "billing_event_number" },\n        { "attribute": "billing_account_number", "field": "billingaccountnumber" }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Input:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "billingaccountnumber": "002800699425",\n  "billingevents": [\n    { "billing_event_number": "002800699425-2025-08-15" },\n    { "billing_event_number": "002800699425-2024-08-05" }\n  ]\n}\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Result:")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Upserts 2 billing_event entities with the specified external_ids"),(0,i.kt)("li",{parentName:"ol"},"Finds all billing_event entities related to billing_account with ",(0,i.kt)("inlineCode",{parentName:"li"},'billing_account_number = "002800699425"')),(0,i.kt)("li",{parentName:"ol"},"Purges any billing_event entities in that scope that weren't in the upserted list")),(0,i.kt)("h4",{id:"example-query-mode-for-direct-matching"},"Example: Query Mode for Direct Matching"),(0,i.kt)("p",null,"Find scope entities directly by query parameters instead of through relations:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "entities": [\n    {\n      "entity_schema": "billing_event",\n      "unique_ids": ["external_id"],\n      "jsonataExpression": "$map(billingevents[], function($v) { $merge([$v, { \\"billingaccountnumber\\": billingaccountnumber }]) })",\n      "mode": "upsert-prune-scope-purge",\n      "scope": {\n        "scope_mode": "query",\n        "query": [\n          {\n            "attribute": "billing_account_number",\n            "field": "billingaccountnumber"\n          },\n          {\n            "attribute": "type",\n            "constant": "INVOICE"\n          }\n        ]\n      },\n      "fields": [\n        { "attribute": "external_id", "field": "billing_event_number" },\n        { "attribute": "billing_account_number", "field": "billingaccountnumber" }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If the array yields zero entities (e.g., ",(0,i.kt)("inlineCode",{parentName:"p"},"billingevents: []"),"), this will result in the deletion of ",(0,i.kt)("strong",{parentName:"p"},"all")," entities in the scope. Ensure your payload always contains the expected data."))),(0,i.kt)("h3",{id:"meter-reading-prune-scope-operations"},"Meter Reading Prune Scope Operations"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"upsert-prune-scope")," mode for meter readings upserts all readings from the payload for a given meter/counter, then permanently deletes all other readings for that meter/counter that weren't part of the upsert."),(0,i.kt)("p",null,"The scope is naturally defined by ",(0,i.kt)("strong",{parentName:"p"},"meter + counter")," \u2014 no explicit ",(0,i.kt)("inlineCode",{parentName:"p"},"scope_mode")," is needed. An optional ",(0,i.kt)("inlineCode",{parentName:"p"},"scope")," object can restrict pruning to readings from a specific source."),(0,i.kt)("h4",{id:"scope-configuration-optional"},"Scope Configuration (optional)"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Property"),(0,i.kt)("th",{parentName:"tr",align:null},"Required"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"source")),(0,i.kt)("td",{parentName:"tr",align:null},"No"),(0,i.kt)("td",{parentName:"tr",align:null},"When set, only readings with this source are eligible for pruning")))),(0,i.kt)("h4",{id:"example-basic-meter-reading-prune-scope"},"Example: Basic Meter Reading Prune Scope"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meter_readings": [\n    {\n      "jsonataExpression": "$.readings",\n      "mode": "upsert-prune-scope",\n      "meter": {\n        "unique_ids": [{ "attribute": "external_id", "field": "meter_id" }]\n      },\n      "meter_counter": {\n        "unique_ids": [{ "attribute": "external_id", "field": "counter_id" }]\n      },\n      "fields": [\n        { "attribute": "external_id", "field": "reading_id" },\n        { "attribute": "timestamp", "field": "read_at" },\n        { "attribute": "source", "constant": "ERP" },\n        { "attribute": "value", "field": "meter_value" }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("p",null,"Upserts all readings from the ",(0,i.kt)("inlineCode",{parentName:"p"},"readings")," array, then deletes any other readings for the same meter+counter not in the payload."),(0,i.kt)("h4",{id:"example-with-source-scope"},"Example: With Source Scope"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meter_readings": [\n    {\n      "jsonataExpression": "$.readings",\n      "mode": "upsert-prune-scope",\n      "scope": { "source": "ERP" },\n      "meter": {\n        "unique_ids": [{ "attribute": "external_id", "field": "meter_id" }]\n      },\n      "meter_counter": {\n        "unique_ids": [{ "attribute": "external_id", "field": "counter_id" }]\n      },\n      "fields": [\n        { "attribute": "external_id", "field": "reading_id" },\n        { "attribute": "timestamp", "field": "read_at" },\n        { "attribute": "source", "constant": "ERP" },\n        { "attribute": "value", "field": "meter_value" }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("p",null,"With ",(0,i.kt)("inlineCode",{parentName:"p"},'source: "ERP"'),", only readings with ",(0,i.kt)("inlineCode",{parentName:"p"},'source: "ERP"')," are eligible for pruning. Manually entered or ECP readings remain untouched."),(0,i.kt)("h4",{id:"important-notes"},"Important Notes"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Scope"),": The scope is always all readings for the meter + counter."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Permanent Deletion"),": Meter reading deletion is always permanent (no soft delete/purge distinction)."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Source Filter Recommended"),": Use ",(0,i.kt)("inlineCode",{parentName:"li"},"source")," to avoid accidentally deleting readings from other sources (e.g., manually entered readings)."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Empty Payload"),": If the payload yields zero readings, all readings in scope will be deleted (the ERP is treated as source of truth)."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"External ID"),": The ",(0,i.kt)("inlineCode",{parentName:"li"},"external_id")," attribute is used to identify which readings to keep during pruning.")),(0,i.kt)("h3",{id:"mixed-operations"},"Mixed Operations"),(0,i.kt)("p",null,"You can mix upsert and delete operations in the same use case by using multiple entity entries with different modes:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "entities": [\n    {\n      "entity_schema": "meter",\n      "unique_ids": ["external_id"],\n      "mode": "upsert",\n      "fields": [\n        { "attribute": "external_id", "field": "meter_id" },\n        { "attribute": "status", "constant": "DECOMMISSIONED" }\n      ]\n    },\n    {\n      "entity_schema": "billing_event",\n      "unique_ids": ["external_id"],\n      "mode": "purge",\n      "jsonataExpression": "billing_events",\n      "fields": [\n        { "attribute": "external_id", "field": "event_id" }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("p",null,'Updates the meter status to "DECOMMISSIONED" while purging associated billing events.'),(0,i.kt)("h2",{id:"field-mapping-priority"},"Field Mapping Priority"),(0,i.kt)("p",null,"When multiple mapping options are specified, they are evaluated in this order:"),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ol",{parentName:"div"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"constant")," -- Fixed value (highest priority)"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"jsonataExpression")," -- Computed value"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"field")," -- Direct field mapping (lowest priority)")))),(0,i.kt)("h2",{id:"array-attribute-operations"},"Array Attribute Operations"),(0,i.kt)("p",null,"Array attributes like ",(0,i.kt)("inlineCode",{parentName:"p"},"_tags")," support operations to control how values are applied:"),(0,i.kt)("h3",{id:"set-_set"},"Set (",(0,i.kt)("inlineCode",{parentName:"h3"},"_set"),")"),(0,i.kt)("p",null,"Replaces the entire array:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attribute": "_tags",\n  "constant": ["CUSTOMER", "VIP", "ACTIVE"]\n}\n')),(0,i.kt)("h3",{id:"append-_append"},"Append (",(0,i.kt)("inlineCode",{parentName:"h3"},"_append"),")"),(0,i.kt)("p",null,"Adds new unique values to existing ones (with automatic deduplication):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attribute": "_tags",\n  "jsonataExpression": "{ \\"_append\\": [\\"NEW_TAG\\", \\"IMPORTED\\"] }"\n}\n')),(0,i.kt)("p",null,"If ",(0,i.kt)("inlineCode",{parentName:"p"},'["EXISTING", "CUSTOMER"]')," already exists on the entity, appending ",(0,i.kt)("inlineCode",{parentName:"p"},'["CUSTOMER", "NEW_TAG"]')," results in ",(0,i.kt)("inlineCode",{parentName:"p"},'["EXISTING", "CUSTOMER", "NEW_TAG"]')," - the duplicate ",(0,i.kt)("inlineCode",{parentName:"p"},"CUSTOMER")," is not added again."),(0,i.kt)("h3",{id:"append-all-_append_all"},"Append All (",(0,i.kt)("inlineCode",{parentName:"h3"},"_append_all"),")"),(0,i.kt)("p",null,"Adds all values without deduplication:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attribute": "_tags",\n  "jsonataExpression": "{ \\"_append_all\\": [\\"AUDIT_LOG\\", \\"PROCESSED\\"] }"\n}\n')),(0,i.kt)("h2",{id:"best-practices"},"Best Practices"),(0,i.kt)("h3",{id:"use-meaningful-unique-ids"},"Use Meaningful Unique IDs"),(0,i.kt)("p",null,"Choose stable identifiers that don't change:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'// Good - stable business identifier\n"unique_ids": ["customer_number"]\n\n// Avoid - may change over time\n"unique_ids": ["email"]\n')),(0,i.kt)("h3",{id:"handle-optional-fields"},"Handle Optional Fields"),(0,i.kt)("p",null,"Use ",(0,i.kt)("inlineCode",{parentName:"p"},"enabled")," to skip fields when data is missing:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attribute": "secondary_email",\n  "field": "alternateEmail",\n  "_type": "email",\n  "enabled": "$exists(alternateEmail)"\n}\n')),(0,i.kt)("h3",{id:"validate-data-with-jsonata"},"Validate Data with JSONata"),(0,i.kt)("p",null,"Transform and validate in one expression:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},"{\n  \"attribute\": \"status\",\n  \"jsonataExpression\": \"status in ['active', 'inactive', 'pending'] ? status : 'unknown'\"\n}\n")),(0,i.kt)("h2",{id:"next-steps"},"Next Steps"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"./unique-identifiers"},"Unique Identifiers")," - Advanced entity lookup strategies"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"./relations"},"Relations")," - Link entities together"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"./meter-readings"},"Meter Readings")," - Handle meter reading data")))}u.isMDXComponent=!0}}]);