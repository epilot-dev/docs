"use strict";(self.webpackChunkepilot_dev_handbook=self.webpackChunkepilot_dev_handbook||[]).push([[69089],{35722:(e,t,n)=>{n.d(t,{G:()=>u});var o=n(42858),a=n(67294),i=n(25108);let s=0,r=!1;const l=(e,t)=>{const n=e?.getAttribute("data-theme")??"light",o="dark"===n?"dark":"default";return t?.theme?.[n]??t?.mermaid?.theme??o},u=e=>{let{chart:t,config:n}=e;const u=(0,a.useRef)(null),p=(0,a.useRef)("mermaid-"+s++),[c,d]=(0,a.useState)(""),m=(0,a.useMemo)((()=>"string"==typeof n?JSON.parse(n):n),[n]);return(0,a.useEffect)((()=>{if("undefined"==typeof window)return;const e=document.querySelector("html"),n=l(e,m);r||(o.Z.initialize({startOnLoad:!1,theme:n,...m?.mermaid||{}}),r=!0);(async()=>{try{const{svg:e}=await o.Z.render(p.current,t);d(e)}catch(e){i.error("Mermaid rendering failed:",e)}})()}),[t,m]),(0,a.useEffect)((()=>{if("undefined"==typeof window)return;const e=document.querySelector("html"),n=new MutationObserver((n=>{for(const a of n){if("attributes"!==a.type||"data-theme"!==a.attributeName)continue;const n=l(e,m);r=!1,o.Z.initialize({startOnLoad:!1,theme:n,...m?.mermaid||{}}),r=!0,p.current="mermaid-"+s++,o.Z.render(p.current,t).then((e=>{let{svg:t}=e;d(t)}));break}}));return n.observe(e,{attributes:!0}),()=>n.disconnect()}),[t,m]),"undefined"==typeof window?a.createElement("div",{className:"mermaid"},t):a.createElement("div",{ref:u,dangerouslySetInnerHTML:{__html:c}})}},67930:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>s,default:()=>c,frontMatter:()=>i,metadata:()=>r,toc:()=>l});var o=n(87462),a=(n(67294),n(3905));n(35722);const i={title:"How to build a custom Journey block",hide_title:!0,sidebar_position:1},s=void 0,r={unversionedId:"apps/how-to-guides/build-a-custom-jb",id:"apps/how-to-guides/build-a-custom-jb",title:"How to build a custom Journey block",description:"How to build a custom Journey block",source:"@site/docs/apps/how-to-guides/build-a-custom-jb.md",sourceDirName:"apps/how-to-guides",slug:"/apps/how-to-guides/build-a-custom-jb",permalink:"/docs/apps/how-to-guides/build-a-custom-jb",editUrl:"https://github.com/epilot-dev/docs/edit/main/docs/apps/how-to-guides/build-a-custom-jb.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"How to build a custom Journey block",hide_title:!0,sidebar_position:1},sidebar:"docsSidebar",previous:{title:"Publishing Requirements",permalink:"/docs/apps/publishing/requirements"}},l=[{value:"How to build a custom Journey block",id:"how-to-build-a-custom-journey-block",children:[{value:"Prerequisites",id:"prerequisites",children:[],level:3},{value:"What we are building",id:"what-we-are-building",children:[],level:3},{value:"Step 1: Create a new project",id:"step-1-create-a-new-project",children:[],level:3},{value:"Step 2: Create the custom block in the App configuration",id:"step-2-create-the-custom-block-in-the-app-configuration",children:[],level:3},{value:"Step 3: Create a dummy journey to test your component",id:"step-3-create-a-dummy-journey-to-test-your-component",children:[],level:3},{value:"Step 4: Subscribe to changes in other blocks",id:"step-4-subscribe-to-changes-in-other-blocks",children:[],level:3},{value:"Step 5: Use component arguments to change the default view of the map",id:"step-5-use-component-arguments-to-change-the-default-view-of-the-map",children:[],level:3},{value:"Step 6: Map the generated lat/lng output back to the journey submission",id:"step-6-map-the-generated-latlng-output-back-to-the-journey-submission",children:[],level:3}],level:2},{value:"Conclusion",id:"conclusion",children:[],level:2}],u={toc:l},p="wrapper";function c(e){let{components:t,...i}=e;return(0,a.kt)(p,(0,o.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"how-to-build-a-custom-journey-block"},"How to build a custom Journey block"),(0,a.kt)("h3",{id:"prerequisites"},"Prerequisites"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Understanding of the epilot platform, particularly what Journeys are and how they work. See the ",(0,a.kt)("a",{parentName:"p",href:"/docs/journeys/journey-builder"},"Journeys documentation")," for more information.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Basic understanding about the concept of an App inside the epilot platform. See the ",(0,a.kt)("a",{parentName:"p",href:"/docs/apps"},"App documentation")," for more information.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Understand what a custom journey block is and how it works. See the ",(0,a.kt)("a",{parentName:"p",href:"/docs/apps/about-apps/components/custom-journey-block"},"Custom Journey Block documentation")," for more information."))),(0,a.kt)("h3",{id:"what-we-are-building"},"What we are building"),(0,a.kt)("p",null,"We are going to build a journey block that renders the inputted address from the address block as a map marker in OpenStreetMap."),(0,a.kt)("p",null,"You can find the finished project ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/epilot-dev/app-component-examples/tree/main/examples/journey-block-openstreetmap"},"here"),"."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"What we build",src:n(5990).Z,width:"2836",height:"1444"})),(0,a.kt)("p",null,"You will learn and understand how to:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"create a new blank project in React that compiles to a web component in a single ",(0,a.kt)("inlineCode",{parentName:"li"},"bundle.js")," file"),(0,a.kt)("li",{parentName:"ul"},"use the ",(0,a.kt)("inlineCode",{parentName:"li"},"development mode")," in Apps in order to have a more convenient way to test your changes in the context of a journey"),(0,a.kt)("li",{parentName:"ul"},"subscribe to changes in other blocks (i.e. the address block) and access this information in your custom block"),(0,a.kt)("li",{parentName:"ul"},"use ",(0,a.kt)("inlineCode",{parentName:"li"},"component arguments")," to pass data from the block configuration to your custom block"),(0,a.kt)("li",{parentName:"ul"},"use ",(0,a.kt)("inlineCode",{parentName:"li"},"component mapping")," to map the output of your custom block (e.g. the lat/lng coordinates of the address) to the submission of the journey")),(0,a.kt)("h3",{id:"step-1-create-a-new-project"},"Step 1: Create a new project"),(0,a.kt)("p",null,"A custom journey block is rendered as a web component in the journey builder. This is particularly useful as we do not care how the web component is implemented, as long as it is a web component. Hence you can use technologies like Lit, Svelte, React, Vue, etc. For this tutorial we use React and the ",(0,a.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@r2wc/react-to-web-component"},"@r2wc/react-to-web-component")," library to compile our React code to a web component."),(0,a.kt)("p",null,"Clone the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/epilot-dev/app-component-examples"},"app-examples")," repo and navigate to the ",(0,a.kt)("inlineCode",{parentName:"p"},"examples/journey-block-openstreetmap")," folder. This contains the fully working example we are building in this guide."),(0,a.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"If you want to start with a fresh ",(0,a.kt)("inlineCode",{parentName:"p"},"minimalistic")," custom block, then head over to the ",(0,a.kt)("inlineCode",{parentName:"p"},"templates/custom-journey-block-react")," folder."))),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"The actual React component you implement is compiled into a web component with")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/main.tsx - Web component registration"',title:'"src/main.tsx',"-":!0,Web:!0,component:!0,'registration"':!0},"const componentTag = 'address-map'\n\nconst CustomBlock = r2wc(App, {\n  props: {\n    value: 'string',\n    errors: 'string',\n    required: 'boolean',\n    // the r2wc lib will parse the string value for us\n    theme: 'json',\n    args: 'json',\n    setValue: 'function',\n    subscribe: 'function'\n  }\n})\n\ncustomElements.define(componentTag, CustomBlock)\n")),(0,a.kt)("p",null,"It is important to expose these props so the platform can pass data to your component. In the future we will probably create a small wrapper around this, but for now you can use them as-is."),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"The Vite config needs to output a single ",(0,a.kt)("inlineCode",{parentName:"li"},"bundle.js")," file. We host this bundle in our CDN and then point the custom block to it.\nThis is a minimal working config.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="vite.config.ts"',title:'"vite.config.ts"'},"import { resolve } from 'path'\nimport { defineConfig } from 'Vite'\nimport react from '@Vitejs/plugin-react'\nimport typescript from '@rollup/plugin-typescript'\nimport cssInjectedByJsPlugin from 'vite-plugin-css-injected-by-js'\n\nexport default defineConfig({\n  plugins: [react(), typescript(), cssInjectedByJsPlugin()],\n  server: {\n    port: 3000,\n    strictPort: true\n  },\n  preview: {\n    allowedHosts: true\n  },\n  define: {\n    'process.env.NODE_ENV': '\"production\"'\n  },\n  build: {\n    lib: {\n      formats: ['umd'],\n      entry: resolve(__dirname, 'src/main.tsx'),\n      name: 'index',\n      fileName: \"bundle.js\",\n    },\n    cssCodeSplit: false, // Ensures a single CSS file output\n    minify: true,\n    sourcemap: false,\n    rollupOptions: {\n      output: {\n        entryFileNames: \"bundle.js\",\n        inlineDynamicImports: true,\n      },\n    },\n  },\n})\n")),(0,a.kt)("p",null,"Install and build the project with"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="Install and build"',title:'"Install',and:!0,'build"':!0},"npm install\nnpm run build\n")),(0,a.kt)("p",null,"During development you can run a local dev server and point development mode to it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="Start local dev server"',title:'"Start',local:!0,dev:!0,'server"':!0},"npm run dev\n")),(0,a.kt)("h3",{id:"step-2-create-the-custom-block-in-the-app-configuration"},"Step 2: Create the custom block in the App configuration"),(0,a.kt)("p",null,"The business logic/internals of the App do not matter for now. We start to focus on the actual development mode. In order to create your first App go to the App configuration and click on the ",(0,a.kt)("inlineCode",{parentName:"p"},"Add Component")," button. Add the ",(0,a.kt)("inlineCode",{parentName:"p"},"bundle.js")," file from the ",(0,a.kt)("inlineCode",{parentName:"p"},"dist")," folder."),(0,a.kt)("p",null,"After you created the component, install the App initially (by selecting the ",(0,a.kt)("inlineCode",{parentName:"p"},"See how your app looks in the installation view")," link in the top right corner of the App configuration builder), then enable the ",(0,a.kt)("a",{parentName:"p",href:"https://docs.epilot.io/docs/apps/about-apps/development-mode"},"development mode"),". "),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Why development mode?")," If you don't enable this during development, you always need to create a new version and update the current installation to the newest version with your changes. This is tedious and takes a lot of time. The development mode always pushes the latest changes to the current installation."),(0,a.kt)("h3",{id:"step-3-create-a-dummy-journey-to-test-your-component"},"Step 3: Create a dummy journey to test your component"),(0,a.kt)("p",null,"Create a dummy journey to test your component. Add the custom block to the journey and test it. Head over to the ",(0,a.kt)("a",{parentName:"p",href:"https://portal.dev.epilot.cloud/app/journey-builder/wizard"},"Journey Builder")," and create a new journey. The journey should contain an Address block, as our custom journey block translates the address of the user into a map marker in OpenStreetMap. "),(0,a.kt)("p",null,"After adding the address block, head again over to the block configuration and either use the block search field or go to the bottom of the blocks to see installed Apps which provide journey blocks."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"View Address Block",src:n(77745).Z,width:"2698",height:"1144"})),(0,a.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"With the ",(0,a.kt)("inlineCode",{parentName:"p"},"development mode")," enabled, you can override the component URL of your Custom Journey Block. This allows you to point the component to a local development server or any other URL where your component is hosted. This way, you can test your changes in the context of a journey without having to publish a new version of your app. It is only important to provide a ",(0,a.kt)("inlineCode",{parentName:"p"},"bundle.js")," file (e.g. ",(0,a.kt)("inlineCode",{parentName:"p"},"http://localhost:3000/bundle.js"),")."))),(0,a.kt)("p",null,"Now you have a custom journey block showing Germany on the map. This is the simplest version of a custom journey block one can implement.\nBut what if you want more interactivity?"),(0,a.kt)("h3",{id:"step-4-subscribe-to-changes-in-other-blocks"},"Step 4: Subscribe to changes in other blocks"),(0,a.kt)("p",null,"We want to subscribe to changes in the address block and update the map accordingly."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Subscribe to changes in the address block"),(0,a.kt)("li",{parentName:"ol"},"Get the lat/lng coordinates of the address"),(0,a.kt)("li",{parentName:"ol"},"Update the map accordingly")),(0,a.kt)("p",null,"To subscribe to changes in other blocks, you can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"subscribe")," function available on the container. This function lets your block react to updates in other blocks."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="Subscribe to address block changes"',title:'"Subscribe',to:!0,address:!0,block:!0,'changes"':!0},' const [address, setAddress] = useState<Address | null>(null)\n\n  const callback = useCallback((partialState: Address)  => {\n    const safe = (partialState as any) ?? {}\n    const { city, houseNumber, streetName, zipCode, countryCode } = safe as Partial<Address>\n\n    if (city && houseNumber && streetName && zipCode) {\n      setAddress({\n        city,\n        houseNumber,\n        streetName,\n        zipCode,\n        countryCode: countryCode ?? ""\n      })\n    } else {\n      setAddress(null)\n    }\n  }, [])\n\n  useEffect(() => {\n    const unsubscribe = props.container.subscribe(BLOCK_ID, callback)\n\n    return () => void unsubscribe()\n  }, [props.container.subscribe, callback, props.container])\n')),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"BLOCK_ID")," is the id of the address block. You can find this id in the block configuration (at the bottom) of the address block."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Block ID",src:n(32664).Z,width:"690",height:"430"})),(0,a.kt)("p",null,"The updates from this subscription are reactive, i.e. whenever the address block is updated, the map will be updated accordingly."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Subscribe example",src:n(33830).Z,width:"800",height:"436"})),(0,a.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"By subscribing to changes in other blocks, you can build very powerful custom blocks that are not limited to the data that is available in the block configuration."))),(0,a.kt)("h3",{id:"step-5-use-component-arguments-to-change-the-default-view-of-the-map"},"Step 5: Use component arguments to change the default view of the map"),(0,a.kt)("p",null,"We want to make the map view configurable. This is a very common use case and can be achieved by using component arguments."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"add a component argument to the custom block"),(0,a.kt)("li",{parentName:"ol"},"use the component argument to change the default view of the map")),(0,a.kt)("p",null,"To add a component argument, you can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"args")," provided via the container. This is a JSON stringified object containing all the args you provide when adding the block."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="Parse and use component arguments"',title:'"Parse',and:!0,use:!0,component:!0,'arguments"':!0},' const args = useMemo(() => {\n    return props.container.args ? JSON.parse(props.container.args) : undefined\n  }, [props.container.args])\n\n  const center = useMemo(() => {\n    const candidate = (args as any)?.default_city\n\n    // String form: "lat,lng"\n    if (typeof candidate === "string") {\n      const parts = candidate.split(",").map(p => Number(p.trim()))\n      if (parts.length === 2 && Number.isFinite(parts[0]) && Number.isFinite(parts[1])) {\n        return [parts[0], parts[1]] as [number, number]\n      }\n    }\n\n    return undefined\n  }, [args])\n')),(0,a.kt)("p",null,"The component arguments are available via ",(0,a.kt)("inlineCode",{parentName:"p"},"props.container.args")," in the custom block."),(0,a.kt)("h3",{id:"step-6-map-the-generated-latlng-output-back-to-the-journey-submission"},"Step 6: Map the generated lat/lng output back to the journey submission"),(0,a.kt)("p",null,"To submit data from your custom block, call ",(0,a.kt)("inlineCode",{parentName:"p"},"setValue")," with your output. For example, after geocoding the address, you can expose the coordinates:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="Set value for journey submission"',title:'"Set',value:!0,for:!0,journey:!0,'submission"':!0},"useEffect(() => {\n  if (!address) return\n  geocode(address).then(({ lat, lng }) => {\n    props.setValue(JSON.stringify({ lat, lng }))\n  })\n}, [address])\n\n// or \n\nconst addCoordsToMapping = useCallback((coords: [number, number] | null) => {\n    props.container.setValue(JSON.stringify({ lat: coords?.[0], lng: coords?.[1] }))\n  }, [args, props.container.setValue])\n")),(0,a.kt)("p",null,"This value can then be mapped using component mapping so it becomes part of the journey submission payload."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Component Arguments",src:n(35867).Z,width:"800",height:"374"})),(0,a.kt)("h2",{id:"conclusion"},"Conclusion"),(0,a.kt)("p",null,"You have now learned how to build a custom journey block that is fully functional and can be used in a journey. You have also learned how to subscribe to changes in other blocks, use component arguments and use component mapping to map the output of your custom block to the submission of the journey."),(0,a.kt)("p",null,"A quick summary:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"a custom journey block is a web component that is rendered in the journey builder"),(0,a.kt)("li",{parentName:"ul"},"you can subscribe to changes in other blocks by using ",(0,a.kt)("inlineCode",{parentName:"li"},"container.subscribe")," and the ",(0,a.kt)("inlineCode",{parentName:"li"},"BLOCK_ID")),(0,a.kt)("li",{parentName:"ul"},"you can use component arguments to pass data from the block configuration to your custom block via ",(0,a.kt)("inlineCode",{parentName:"li"},"container.args")),(0,a.kt)("li",{parentName:"ul"},"you can use ",(0,a.kt)("inlineCode",{parentName:"li"},"setValue")," and component mapping to map the output of your custom block to the submission of the journey")),(0,a.kt)("p",null,"You can find the finished project ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/epilot-dev/app-component-examples/tree/main/examples/journey-block-openstreetmap"},"here"),"."))}c.isMDXComponent=!0},32664:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/block-id-dd841f4fbd63a8dae37cdd6ee2f8e0f9.png"},35867:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/component-args-toggle-2e434d7b90aa180833f70b04e72f368a.gif"},77745:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/jb-view-1-7c22bcfb513cf1cd9ab5787c83dde319.png"},33830:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/subscribe-55b1032e3aef39d89d5af431a233bd57.gif"},5990:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/what-we-will-build-0bb317f8c77a2ea048d57050cdf064f5.png"}}]);