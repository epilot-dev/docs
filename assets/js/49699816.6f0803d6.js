"use strict";(self.webpackChunkepilot_dev_handbook=self.webpackChunkepilot_dev_handbook||[]).push([[22787],{35722:(e,t,a)=>{a.d(t,{G:()=>p});var n=a(42858),i=a(67294),l=a(25108);let o=0,r=!1;const s=(e,t)=>{const a=e?.getAttribute("data-theme")??"light",n="dark"===a?"dark":"default";return t?.theme?.[a]??t?.mermaid?.theme??n},p=e=>{let{chart:t,config:a}=e;const p=(0,i.useRef)(null),d=(0,i.useRef)("mermaid-"+o++),[m,c]=(0,i.useState)(""),u=(0,i.useMemo)((()=>"string"==typeof a?JSON.parse(a):a),[a]);return(0,i.useEffect)((()=>{if("undefined"==typeof window)return;const e=document.querySelector("html"),a=s(e,u);r||(n.Z.initialize({startOnLoad:!1,theme:a,...u?.mermaid||{}}),r=!0);(async()=>{try{const{svg:e}=await n.Z.render(d.current,t);c(e)}catch(e){l.error("Mermaid rendering failed:",e)}})()}),[t,u]),(0,i.useEffect)((()=>{if("undefined"==typeof window)return;const e=document.querySelector("html"),a=new MutationObserver((a=>{for(const i of a){if("attributes"!==i.type||"data-theme"!==i.attributeName)continue;const a=s(e,u);r=!1,n.Z.initialize({startOnLoad:!1,theme:a,...u?.mermaid||{}}),r=!0,d.current="mermaid-"+o++,n.Z.render(d.current,t).then((e=>{let{svg:t}=e;c(t)}));break}}));return a.observe(e,{attributes:!0}),()=>a.disconnect()}),[t,u]),"undefined"==typeof window?i.createElement("div",{className:"mermaid"},t):i.createElement("div",{ref:p,dangerouslySetInnerHTML:{__html:m}})}},51128:(e,t,a)=>{a.r(t),a.d(t,{contentTitle:()=>r,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var n=a(87462),i=(a(67294),a(3905)),l=a(35722);const o={sidebar_position:2},r="File API",s={unversionedId:"files/file-api",id:"files/file-api",title:"File API",description:"[API Docs]",source:"@site/docs/files/file-api.md",sourceDirName:"files",slug:"/files/file-api",permalink:"/docs/files/file-api",editUrl:"https://github.com/epilot-dev/docs/edit/main/docs/files/file-api.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"docsSidebar",previous:{title:"File Entity",permalink:"/docs/files/file-entity"},next:{title:"Document Generation",permalink:"/docs/files/document-generation"}},p=[{value:"Downloading Files",id:"downloading-files",children:[],level:2},{value:"Uploading Files",id:"uploading-files",children:[],level:2},{value:"Example Upload Flow",id:"example-upload-flow",children:[{value:"Step 1: Call uploadFileV2 to get an s3ref",id:"step-1-call-uploadfilev2-to-get-an-s3ref",children:[],level:3},{value:"Step 2: Upload the file to S3",id:"step-2-upload-the-file-to-s3",children:[],level:3},{value:"Step 3: Call saveFileV2 to persist the file",id:"step-3-call-savefilev2-to-persist-the-file",children:[],level:3}],level:2},{value:"External Files",id:"external-files",children:[{value:"File Proxy for ERP Integrations",id:"file-proxy-for-erp-integrations",children:[],level:3}],level:2},{value:"Updating Files",id:"updating-files",children:[],level:2},{value:"Deleting Files",id:"deleting-files",children:[],level:2}],d={toc:p},m="wrapper";function c(e){let{components:t,...o}=e;return(0,i.kt)(m,(0,n.Z)({},d,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"file-api"},"File API"),(0,i.kt)("p",null,"[",(0,i.kt)("a",{parentName:"p",href:"/api/file"},"API Docs"),"]\n[",(0,i.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@epilot/file-client"},"SDK"),"]"),(0,i.kt)("p",null,"Files in epilot are uploaded and managed through the ",(0,i.kt)("a",{parentName:"p",href:"/api/file"},"File API"),"."),(0,i.kt)("h2",{id:"downloading-files"},"Downloading Files"),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"/api/file#tag/files/operation/downloadFile"},(0,i.kt)("inlineCode",{parentName:"a"},"downloadFile")," operation")," returns a temporary presigned S3 URL for downloading a file."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"GET /v1/files/{id}/download\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="Response"',title:'"Response"'},'{\n  "download_url": "https://epilot-prod-user-content.s3.eu-central-1.amazonaws.com/...?X-Amz-..."\n}\n')),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"download_url")," is valid for 15 minutes."),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"downloadFile")," operation requires a valid access token."))),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Public files can also be downloaded directly via their ",(0,i.kt)("inlineCode",{parentName:"p"},"public_url")," property. However, ",(0,i.kt)("inlineCode",{parentName:"p"},"downloadFile")," works for both public and private files and is the recommended approach."))),(0,i.kt)("h2",{id:"uploading-files"},"Uploading Files"),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"/api/file#tag/files/operation/uploadFileV2"},(0,i.kt)("inlineCode",{parentName:"a"},"uploadFileV2")," operation")," returns a temporary presigned S3 URL for uploading a file via ",(0,i.kt)("inlineCode",{parentName:"p"},"PUT"),"."),(0,i.kt)("p",null,"After uploading, call ",(0,i.kt)("a",{parentName:"p",href:"/api/file#tag/files/operation/saveFileV2"},(0,i.kt)("inlineCode",{parentName:"a"},"saveFileV2"))," to persist the file and create a File entity. Files that are uploaded but not saved expire and are deleted within 24 hours."),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},(0,i.kt)("inlineCode",{parentName:"p"},"uploadFileV2")," requires a valid access token. Use ",(0,i.kt)("inlineCode",{parentName:"p"},"uploadFilePublic")," for public journey submissions."))),(0,i.kt)("h2",{id:"example-upload-flow"},"Example Upload Flow"),(0,i.kt)(l.G,{chart:"sequenceDiagram\n    participant Client\n    participant FileAPI as File API\n    participant S3 as S3\n\n    Client->>FileAPI: POST /v2/files/upload\n    FileAPI--\x3e>Client: upload_url + s3ref\n    Client->>S3: PUT upload_url (binary)\n    S3--\x3e>Client: 200 OK\n    Client->>FileAPI: POST /v2/files (saveFileV2)\n    FileAPI--\x3e>Client: File entity",mdxType:"Mermaid"}),(0,i.kt)("h3",{id:"step-1-call-uploadfilev2-to-get-an-s3ref"},"Step 1: Call uploadFileV2 to get an s3ref"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"POST /v2/files/upload\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="Request body"',title:'"Request','body"':!0},'{\n  "filename": "example.pdf",\n  "mime_type": "application/pdf"\n}\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="Response (201)"',title:'"Response','(201)"':!0},'{\n  "s3ref": {\n    "bucket": "epilot-prod-user-content",\n    "key": "123/temp/f5e1c2be-7392-4a0d-8c45-236743423733/example.pdf"\n  },\n  "upload_url": "https://epilot-prod-user-content.s3.eu-central-1.amazonaws.com/...?X-Amz-...",\n  "public_url": "https://epilot-prod-user-content.s3.eu-central-1.amazonaws.com/..."\n}\n')),(0,i.kt)("h3",{id:"step-2-upload-the-file-to-s3"},"Step 2: Upload the file to S3"),(0,i.kt)("p",null,"Use the returned ",(0,i.kt)("inlineCode",{parentName:"p"},"upload_url")," to upload your file via ",(0,i.kt)("inlineCode",{parentName:"p"},"PUT"),"."),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Set the ",(0,i.kt)("inlineCode",{parentName:"p"},"Content-Type")," header to match the file's MIME type."))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"PUT {upload_url}\nContent-Type: application/pdf\n\n(binary data)\n")),(0,i.kt)("h3",{id:"step-3-call-savefilev2-to-persist-the-file"},"Step 3: Call saveFileV2 to persist the file"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"POST /v2/files\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="Request body"',title:'"Request','body"':!0},'{\n  "s3ref": {\n    "bucket": "epilot-prod-user-content",\n    "key": "123/temp/f5e1c2be-7392-4a0d-8c45-236743423733/example.pdf"\n  },\n  "filename": "example.pdf",\n  "access_control": "private"\n}\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="Response (201)"',title:'"Response','(201)"':!0},'{\n  "_id": "ef7d985c-2385-44f4-9c71-ae06a52264f8",\n  "filename": "example.pdf",\n  "access_control": "private",\n  "public_url": "...",\n  "type": "document",\n  "mime_type": "application/pdf",\n  "size_bytes": 0,\n  "versions": [...]\n}\n')),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"public_url")," property is always present in the response. When ",(0,i.kt)("inlineCode",{parentName:"p"},"access_control")," is ",(0,i.kt)("inlineCode",{parentName:"p"},"private"),", the URL returns a 403 response."))),(0,i.kt)("p",null,"Attach the returned file entity ID to a business entity as a relation on any ",(0,i.kt)("inlineCode",{parentName:"p"},"file")," attribute, or the default ",(0,i.kt)("inlineCode",{parentName:"p"},"_files")," attribute:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "_schema": "opportunity",\n  // ...other entity fields\n  "_files": {\n    "$relation": [\n      { "entity_id": "ef7d985c-2385-44f4-9c71-ae06a52264f8" }\n    ]\n  }\n}\n')),(0,i.kt)("h2",{id:"external-files"},"External Files"),(0,i.kt)("p",null,"When migrating a large document archive is impractical, skip the upload steps and use the ",(0,i.kt)("inlineCode",{parentName:"p"},"custom_download_url")," property to reference files stored externally."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"POST /v2/files\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="Request body"',title:'"Request','body"':!0},'{\n  "custom_download_url": "https://external-url.io?fileID=42",\n  "filename": "example.pdf",\n  "access_control": "private"\n}\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="Response (201)"',title:'"Response','(201)"':!0},'{\n  "_id": "ef7d985c-2385-44f4-9c71-ae06a52264f8",\n  "filename": "example.pdf",\n  "access_control": "private",\n  "custom_download_url": "https://external-url.io?fileID=42",\n  "type": "unknown",\n  "size_bytes": 0,\n  "versions": [...]\n}\n')),(0,i.kt)("p",null,"epilot retrieves external files on the fly with a short-lived signature and streams them directly to the end user. Use the ",(0,i.kt)("a",{parentName:"p",href:"/api/file#tag/files/operation/verifyCustomDownloadUrl"},(0,i.kt)("inlineCode",{parentName:"a"},"verifyCustomDownloadUrl")," operation")," to verify that a download request originates from epilot."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"External file download flow",src:a(89283).Z,width:"2802",height:"1632"})),(0,i.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Download requests for external files come from the user's browser. Do not include sensitive data (internal tokens, credentials) in the response -- the end user can inspect all response headers and content."))),(0,i.kt)("h3",{id:"file-proxy-for-erp-integrations"},"File Proxy for ERP Integrations"),(0,i.kt)("p",null,"When integrating with ERP document archives that require authentication or multi-step API calls to fetch files, use the ",(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("a",{parentName:"strong",href:"/docs/integrations/erp-toolkit/file-proxy"},"File Proxy"))," from the ERP Toolkit. The file proxy handles OAuth2 authentication, secret management, and complex download flows declaratively \u2014 file entities are created with a ",(0,i.kt)("inlineCode",{parentName:"p"},"custom_download_url")," pointing to the proxy, and files are fetched on demand when users view them."),(0,i.kt)("h2",{id:"updating-files"},"Updating Files"),(0,i.kt)("p",null,"Update or save new versions of File entities via the ",(0,i.kt)("a",{parentName:"p",href:"/api/file#tag/files/operation/saveFileV2"},(0,i.kt)("inlineCode",{parentName:"a"},"saveFileV2")," operation"),"."),(0,i.kt)("h2",{id:"deleting-files"},"Deleting Files"),(0,i.kt)("p",null,"Delete files using the ",(0,i.kt)("a",{parentName:"p",href:"/api/file#tag/files/operation/deleteFile"},(0,i.kt)("inlineCode",{parentName:"a"},"deleteFile")," operation"),". This permanently deletes both the File entity and the underlying S3 object."))}c.isMDXComponent=!0},89283:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/file-custom-url-flow-cd74f5f60c9203447018c5a025e32d17.png"}}]);