"use strict";(self.webpackChunkepilot_dev_handbook=self.webpackChunkepilot_dev_handbook||[]).push([[2898],{35722:(e,t,n)=>{n.d(t,{G:()=>o});var a=n(42858),i=n(67294),r=n(25108);let l=0,d=!1;const s=(e,t)=>{const n=e?.getAttribute("data-theme")??"light",a="dark"===n?"dark":"default";return t?.theme?.[n]??t?.mermaid?.theme??a},o=e=>{let{chart:t,config:n}=e;const o=(0,i.useRef)(null),u=(0,i.useRef)("mermaid-"+l++),[p,m]=(0,i.useState)(""),c=(0,i.useMemo)((()=>"string"==typeof n?JSON.parse(n):n),[n]);return(0,i.useEffect)((()=>{if("undefined"==typeof window)return;const e=document.querySelector("html"),n=s(e,c);d||(a.Z.initialize({startOnLoad:!1,theme:n,...c?.mermaid||{}}),d=!0);(async()=>{try{const{svg:e}=await a.Z.render(u.current,t);m(e)}catch(e){r.error("Mermaid rendering failed:",e)}})()}),[t,c]),(0,i.useEffect)((()=>{if("undefined"==typeof window)return;const e=document.querySelector("html"),n=new MutationObserver((n=>{for(const i of n){if("attributes"!==i.type||"data-theme"!==i.attributeName)continue;const n=s(e,c);d=!1,a.Z.initialize({startOnLoad:!1,theme:n,...c?.mermaid||{}}),d=!0,u.current="mermaid-"+l++,a.Z.render(u.current,t).then((e=>{let{svg:t}=e;m(t)}));break}}));return n.observe(e,{attributes:!0}),()=>n.disconnect()}),[t,c]),"undefined"==typeof window?i.createElement("div",{className:"mermaid"},t):i.createElement("div",{ref:o,dangerouslySetInnerHTML:{__html:p}})}},81889:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>d,toc:()=>s});var a=n(87462),i=(n(67294),n(3905));n(35722);const r={sidebar_position:5,title:"Meter Readings",description:"Synchronize meter reading data from ERP systems"},l="Meter Readings",d={unversionedId:"integrations/erp-toolkit/inbound/meter-readings",id:"integrations/erp-toolkit/inbound/meter-readings",title:"Meter Readings",description:"Synchronize meter reading data from ERP systems",source:"@site/docs/integrations/erp-toolkit/inbound/meter-readings.md",sourceDirName:"integrations/erp-toolkit/inbound",slug:"/integrations/erp-toolkit/inbound/meter-readings",permalink:"/docs/integrations/erp-toolkit/inbound/meter-readings",editUrl:"https://github.com/epilot-dev/docs/edit/main/docs/integrations/erp-toolkit/inbound/meter-readings.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5,title:"Meter Readings",description:"Synchronize meter reading data from ERP systems"},sidebar:"docsSidebar",previous:{title:"Relations",permalink:"/docs/integrations/erp-toolkit/inbound/relations"},next:{title:"Examples",permalink:"/docs/integrations/erp-toolkit/inbound/examples"}},s=[{value:"Overview",id:"overview",children:[],level:2},{value:"Configuration Structure",id:"configuration-structure",children:[{value:"Required Fields",id:"required-fields",children:[],level:3},{value:"Optional Properties",id:"optional-properties",children:[],level:3}],level:2},{value:"Meter Configuration",id:"meter-configuration",children:[{value:"Meter Lookup",id:"meter-lookup",children:[],level:3},{value:"Meter Identifier Source",id:"meter-identifier-source",children:[],level:3},{value:"Meter Counter (Multi-Tariff)",id:"meter-counter-multi-tariff",children:[],level:3}],level:2},{value:"Field Mappings",id:"field-mappings",children:[{value:"Basic Reading Fields",id:"basic-reading-fields",children:[],level:3},{value:"Reading Types",id:"reading-types",children:[],level:3},{value:"Multiple Value Types",id:"multiple-value-types",children:[],level:3}],level:2},{value:"JSONata Expressions",id:"jsonata-expressions",children:[{value:"Extract Readings Array",id:"extract-readings-array",children:[],level:3},{value:"Flatten Nested Structures",id:"flatten-nested-structures",children:[],level:3},{value:"Transform Before Mapping",id:"transform-before-mapping",children:[],level:3}],level:2},{value:"Complete Example",id:"complete-example",children:[{value:"Input Payload",id:"input-payload",children:[],level:3},{value:"Mapping Configuration",id:"mapping-configuration",children:[],level:3}],level:2},{value:"Deduplication",id:"deduplication",children:[],level:2},{value:"Processing Flow",id:"processing-flow",children:[],level:2},{value:"Error Handling",id:"error-handling",children:[{value:"Meter Not Found",id:"meter-not-found",children:[],level:3},{value:"Invalid Reading Value",id:"invalid-reading-value",children:[],level:3}],level:2},{value:"Reading Matching Strategies",id:"reading-matching-strategies",children:[{value:"Using strict-date",id:"using-strict-date",children:[],level:3}],level:2},{value:"Meter Reading Deletion",id:"meter-reading-deletion",children:[{value:"Deletion with Strict Date Matching",id:"deletion-with-strict-date-matching",children:[],level:3}],level:2},{value:"Prune Scope",id:"prune-scope",children:[{value:"Scope Configuration (optional)",id:"scope-configuration-optional",children:[],level:3},{value:"Basic Prune Scope Example",id:"basic-prune-scope-example",children:[],level:3},{value:"Prune Scope with Source Filter",id:"prune-scope-with-source-filter",children:[],level:3},{value:"Important Notes",id:"important-notes",children:[],level:3}],level:2},{value:"Best Practices",id:"best-practices",children:[{value:"Ensure Meters Exist First",id:"ensure-meters-exist-first",children:[],level:3},{value:"Use Batch Identifiers",id:"use-batch-identifiers",children:[],level:3},{value:"Handle Missing Readings Gracefully",id:"handle-missing-readings-gracefully",children:[],level:3},{value:"Validate Value Ranges",id:"validate-value-ranges",children:[],level:3}],level:2},{value:"Next Steps",id:"next-steps",children:[],level:2}],o={toc:s},u="wrapper";function p(e){let{components:t,...n}=e;return(0,i.kt)(u,(0,a.Z)({},o,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"meter-readings"},"Meter Readings"),(0,i.kt)("p",null,"The ERP Toolkit provides specialized support for meter reading data, common in utility and energy industry integrations."),(0,i.kt)("h2",{id:"overview"},"Overview"),(0,i.kt)("p",null,"Meter readings require special handling because they:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Come as arrays of readings per meter"),(0,i.kt)("li",{parentName:"ul"},"Need to be linked to existing meter entities"),(0,i.kt)("li",{parentName:"ul"},"Contain time-series data with timestamps and values")),(0,i.kt)("h2",{id:"configuration-structure"},"Configuration Structure"),(0,i.kt)("p",null,"Meter readings are configured separately from entity mappings:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "entities": [...],\n  "meter_readings": [\n    {\n      "jsonataExpression": "$.readings",\n      "meter": {\n        "unique_ids": [\n          { "attribute": "external_id", "field": "meter_id" }\n        ]\n      },\n      "fields": [\n        { "attribute": "external_id", "field": "reading_id" },\n        { "attribute": "timestamp", "field": "read_at" },\n        { "attribute": "source", "constant": "ERP" },\n        { "attribute": "value", "field": "reading_value" }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("h3",{id:"required-fields"},"Required Fields"),(0,i.kt)("p",null,"Every meter reading configuration must include mappings for these fields:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Field"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"external_id")),(0,i.kt)("td",{parentName:"tr",align:null},"Unique identifier for this reading")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"timestamp")),(0,i.kt)("td",{parentName:"tr",align:null},"When the reading was taken (ISO 8601 format)")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"source")),(0,i.kt)("td",{parentName:"tr",align:null},"Origin of the reading. Must be one of: ",(0,i.kt)("inlineCode",{parentName:"td"},"ERP"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"ECP"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"360"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"journey-submission"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"value")),(0,i.kt)("td",{parentName:"tr",align:null},"The actual meter reading value")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"reason")," ",(0,i.kt)("em",{parentName:"td"},"(optional)")),(0,i.kt)("td",{parentName:"tr",align:null},"Reason for the reading. Must be one of: ",(0,i.kt)("inlineCode",{parentName:"td"},"regular"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"irregular"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"last"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"first"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"meter_change"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"contract_change"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"meter_adjustment"),", or empty/null. Invalid values will be rejected with a validation error.")))),(0,i.kt)("h3",{id:"optional-properties"},"Optional Properties"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Property"),(0,i.kt)("th",{parentName:"tr",align:null},"Type"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"mode")),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"Operation mode: ",(0,i.kt)("inlineCode",{parentName:"td"},"upsert")," (default), ",(0,i.kt)("inlineCode",{parentName:"td"},"delete"),", or ",(0,i.kt)("inlineCode",{parentName:"td"},"upsert-prune-scope"),". Note: ",(0,i.kt)("inlineCode",{parentName:"td"},"purge")," is not supported for meter readings. See ",(0,i.kt)("a",{parentName:"td",href:"#prune-scope"},"Prune Scope"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"reading_matching")),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"Matching strategy: ",(0,i.kt)("inlineCode",{parentName:"td"},"external_id")," (default) or ",(0,i.kt)("inlineCode",{parentName:"td"},"strict-date"),". See ",(0,i.kt)("a",{parentName:"td",href:"#reading-matching-strategies"},"Reading Matching Strategies"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"jsonataExpression")),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"Extract readings from nested payload structures")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"meter_counter")),(0,i.kt)("td",{parentName:"tr",align:null},"object"),(0,i.kt)("td",{parentName:"tr",align:null},"For multi-tariff meters, identifies the specific counter")))),(0,i.kt)("p",null,"Missing required fields will result in a validation error:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Meter readings configuration (item 0) is missing required field attributes: timestamp, source\n")),(0,i.kt)("h2",{id:"meter-configuration"},"Meter Configuration"),(0,i.kt)("h3",{id:"meter-lookup"},"Meter Lookup"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"meter")," object defines how to find the associated meter entity:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meter": {\n    "unique_ids": ["meter_number"]\n  }\n}\n')),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Property"),(0,i.kt)("th",{parentName:"tr",align:null},"Type"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"unique_ids")),(0,i.kt)("td",{parentName:"tr",align:null},"string[]"),(0,i.kt)("td",{parentName:"tr",align:null},"Fields to identify the meter entity")))),(0,i.kt)("h3",{id:"meter-identifier-source"},"Meter Identifier Source"),(0,i.kt)("p",null,"The meter identifier value comes from the reading data:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'// Input payload\n{\n  "readings": [\n    {\n      "meter_number": "M001",\n      "readingDate": "2024-01-15",\n      "readingValue": 12500\n    }\n  ]\n}\n')),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"meter_number")," field within each reading is used to find the meter."),(0,i.kt)("h3",{id:"meter-counter-multi-tariff"},"Meter Counter (Multi-Tariff)"),(0,i.kt)("p",null,"For meters with multiple counters (e.g., day/night tariffs), specify the counter:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meter": {\n    "unique_ids": [\n      { "attribute": "external_id", "field": "meter_id" }\n    ]\n  },\n  "meter_counter": {\n    "unique_ids": [\n      { "attribute": "external_id", "field": "counter_id" }\n    ]\n  },\n  "fields": [...]\n}\n')),(0,i.kt)("h2",{id:"field-mappings"},"Field Mappings"),(0,i.kt)("h3",{id:"basic-reading-fields"},"Basic Reading Fields"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "fields": [\n    { "attribute": "reading_date", "field": "date" },\n    { "attribute": "value", "field": "reading" },\n    { "attribute": "unit", "constant": "kWh" }\n  ]\n}\n')),(0,i.kt)("h3",{id:"reading-types"},"Reading Types"),(0,i.kt)("p",null,"Map the reading type or category:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "fields": [\n    { "attribute": "reading_date", "field": "date" },\n    { "attribute": "value", "field": "reading" },\n    { "attribute": "reading_type", "field": "type" },\n    { "attribute": "source", "constant": "ERP_IMPORT" }\n  ]\n}\n')),(0,i.kt)("h3",{id:"multiple-value-types"},"Multiple Value Types"),(0,i.kt)("p",null,"Some meters have multiple reading values (e.g., HT/NT for electricity):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meter_readings": [\n    {\n      "jsonataExpression": "$.readings.{\'meter_number\': meterId, \'reading_date\': date, \'value\': htValue, \'tariff\': \'HT\'}",\n      "meter": { "unique_ids": ["meter_number"] },\n      "fields": [\n        { "attribute": "reading_date", "field": "reading_date" },\n        { "attribute": "value", "field": "value" },\n        { "attribute": "tariff", "field": "tariff" }\n      ]\n    },\n    {\n      "jsonataExpression": "$.readings.{\'meter_number\': meterId, \'reading_date\': date, \'value\': ntValue, \'tariff\': \'NT\'}",\n      "meter": { "unique_ids": ["meter_number"] },\n      "fields": [\n        { "attribute": "reading_date", "field": "reading_date" },\n        { "attribute": "value", "field": "value" },\n        { "attribute": "tariff", "field": "tariff" }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("h2",{id:"jsonata-expressions"},"JSONata Expressions"),(0,i.kt)("h3",{id:"extract-readings-array"},"Extract Readings Array"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "jsonataExpression": "$.readings"\n}\n')),(0,i.kt)("p",null,"From payload:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "readings": [\n    { "meterId": "M001", "date": "2024-01-15", "value": 12500 },\n    { "meterId": "M002", "date": "2024-01-15", "value": 8300 }\n  ]\n}\n')),(0,i.kt)("h3",{id:"flatten-nested-structures"},"Flatten Nested Structures"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "jsonataExpression": "$.meters.readings"\n}\n')),(0,i.kt)("p",null,"From payload:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meters": [\n    {\n      "readings": [\n        { "meter_number": "M001", "date": "2024-01-15", "value": 12500 }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("h3",{id:"transform-before-mapping"},"Transform Before Mapping"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},"{\n  \"jsonataExpression\": \"$.readings.{'meter_number': meterId, 'reading_date': $fromMillis(timestamp), 'value': $number(readingValue)}\"\n}\n")),(0,i.kt)("h2",{id:"complete-example"},"Complete Example"),(0,i.kt)("h3",{id:"input-payload"},"Input Payload"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "batchId": "BATCH-2024-01-15",\n  "readingDate": "2024-01-15T08:00:00Z",\n  "readings": [\n    {\n      "meterId": "M001",\n      "meterType": "electricity",\n      "currentReading": 12500.5,\n      "previousReading": 12000.0,\n      "unit": "kWh"\n    },\n    {\n      "meterId": "M002",\n      "meterType": "gas",\n      "currentReading": 450.25,\n      "previousReading": 420.00,\n      "unit": "m3"\n    }\n  ]\n}\n')),(0,i.kt)("h3",{id:"mapping-configuration"},"Mapping Configuration"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meter_readings": [\n    {\n      "jsonataExpression": "readings",\n      "meter": {\n        "unique_ids": ["meter_number"]\n      },\n      "fields": [\n        { "attribute": "meter_number", "field": "meterId" },\n        { "attribute": "reading_date", "field": "$$.readingDate" },\n        { "attribute": "value", "field": "currentReading" },\n        { "attribute": "previous_value", "field": "previousReading" },\n        { "attribute": "unit", "field": "unit" },\n        {\n          "attribute": "consumption",\n          "jsonataExpression": "currentReading - previousReading"\n        },\n        { "attribute": "source", "constant": "ERP_BATCH_IMPORT" },\n        { "attribute": "batch_id", "field": "$$.batchId" }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("p",null,"Note: ",(0,i.kt)("inlineCode",{parentName:"p"},"$$")," references the root payload, allowing access to batch-level fields from within the readings array."),(0,i.kt)("h2",{id:"deduplication"},"Deduplication"),(0,i.kt)("p",null,"Meter readings are deduplicated based on:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Meter identifier"),(0,i.kt)("li",{parentName:"ul"},"Reading date"),(0,i.kt)("li",{parentName:"ul"},"Reading type (if specified)")),(0,i.kt)("p",null,"Duplicate readings within a 24-hour window are skipped."),(0,i.kt)("h2",{id:"processing-flow"},"Processing Flow"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Extract Readings Array (JSONata)\n            \u2502\n            \u25bc\n    For Each Reading:\n            \u2502\n            \u251c\u2500\u2500\u25b6 Extract Meter Identifier\n            \u2502\n            \u251c\u2500\u2500\u25b6 Find Meter Entity\n            \u2502         \u2502\n            \u2502         \u251c\u2500 Found \u2500\u2500\u25b6 Continue\n            \u2502         \u2502\n            \u2502         \u2514\u2500 Not Found \u2500\u2500\u25b6 Skip/Error\n            \u2502\n            \u251c\u2500\u2500\u25b6 Apply Field Mappings\n            \u2502\n            \u251c\u2500\u2500\u25b6 Check Deduplication\n            \u2502         \u2502\n            \u2502         \u251c\u2500 Unique \u2500\u2500\u25b6 Create Reading\n            \u2502         \u2502\n            \u2502         \u2514\u2500 Duplicate \u2500\u2500\u25b6 Skip\n            \u2502\n            \u2514\u2500\u2500\u25b6 Create meter_reading Entity\n")),(0,i.kt)("h2",{id:"error-handling"},"Error Handling"),(0,i.kt)("h3",{id:"meter-not-found"},"Meter Not Found"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "status": "error",\n  "message": "Meter not found",\n  "error": {\n    "code": "METER_NOT_FOUND",\n    "details": {\n      "meter_number": "M999"\n    }\n  }\n}\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Resolution:")," Ensure meters exist before importing readings, or process meters first."),(0,i.kt)("h3",{id:"invalid-reading-value"},"Invalid Reading Value"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "status": "error",\n  "message": "Invalid reading value",\n  "error": {\n    "code": "INVALID_READING_VALUE",\n    "details": {\n      "field": "value",\n      "received": "not-a-number"\n    }\n  }\n}\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Resolution:")," Validate and transform values using JSONata before mapping."),(0,i.kt)("h2",{id:"reading-matching-strategies"},"Reading Matching Strategies"),(0,i.kt)("p",null,"By default, meter readings use ",(0,i.kt)("inlineCode",{parentName:"p"},"external_id")," for upsert matching. When readings originate from the End Customer Portal (ECP) and are later echoed back by the ERP, duplicates can occur because ECP readings may not have an ",(0,i.kt)("inlineCode",{parentName:"p"},"external_id")," initially."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"reading_matching")," option configures matching behavior:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Strategy"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"external_id")),(0,i.kt)("td",{parentName:"tr",align:null},"Default. Match readings by ",(0,i.kt)("inlineCode",{parentName:"td"},"external_id")," attribute")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"strict-date")),(0,i.kt)("td",{parentName:"tr",align:null},"Match by meter_id + counter_id + direction + date (German timezone)")))),(0,i.kt)("h3",{id:"using-strict-date"},"Using strict-date"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meter_readings": [\n    {\n      "reading_matching": "strict-date",\n      "meter": { ... },\n      "fields": [ ... ]\n    }\n  ]\n}\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"How strict-date works:")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Looks up existing readings for the same meter_id + counter_id + direction on the same German calendar day"),(0,i.kt)("li",{parentName:"ol"},"Single match: updates the existing reading with ERP data"),(0,i.kt)("li",{parentName:"ol"},"Multiple matches: logs an error and skips to avoid duplicates"),(0,i.kt)("li",{parentName:"ol"},"No match: creates a new reading")),(0,i.kt)("p",null,"This strategy handles ECP-to-ERP roundtrip scenarios where the ERP echoes readings back with truncated timestamps."),(0,i.kt)("h2",{id:"meter-reading-deletion"},"Meter Reading Deletion"),(0,i.kt)("p",null,"To delete meter readings, use ",(0,i.kt)("inlineCode",{parentName:"p"},'mode: "delete"'),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meter_readings": [\n    {\n      "mode": "delete",\n      "meter": {\n        "unique_ids": [\n          { "attribute": "external_id", "field": "meter_id" }\n        ]\n      },\n      "fields": [\n        { "attribute": "external_id", "field": "reading_id" }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Meter readings support ",(0,i.kt)("inlineCode",{parentName:"p"},"delete")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"upsert-prune-scope")," modes, but not ",(0,i.kt)("inlineCode",{parentName:"p"},"purge"),". Deletion is always permanent."))),(0,i.kt)("h3",{id:"deletion-with-strict-date-matching"},"Deletion with Strict Date Matching"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},'reading_matching: "strict-date"')," strategy is particularly useful for deletion when readings may not have a stable ",(0,i.kt)("inlineCode",{parentName:"p"},"external_id"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meter_readings": [\n    {\n      "mode": "delete",\n      "reading_matching": "strict-date",\n      "meter": {\n        "unique_ids": [\n          { "attribute": "external_id", "field": "meter_id" }\n        ]\n      },\n      "fields": [\n        { "attribute": "external_id", "field": "reading_id" },\n        { "attribute": "timestamp", "field": "timestamp" }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Input:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meter_id": "M-12345",\n  "reading_id": "R-67890",\n  "timestamp": "2025-02-01T10:00:00Z"\n}\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Result:")," The meter reading with ",(0,i.kt)("inlineCode",{parentName:"p"},'external_id = "R-67890"')," associated with meter ",(0,i.kt)("inlineCode",{parentName:"p"},"M-12345")," will be deleted. With ",(0,i.kt)("inlineCode",{parentName:"p"},"strict-date")," matching, the system matches by meter_id + date if an exact external_id match is not found."),(0,i.kt)("h2",{id:"prune-scope"},"Prune Scope"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"upsert-prune-scope")," mode upserts all readings from the payload for a given meter/counter, then permanently deletes all other readings for that meter/counter that weren't part of the upsert."),(0,i.kt)("p",null,"The scope is naturally defined by ",(0,i.kt)("strong",{parentName:"p"},"meter + counter")," \u2014 no explicit ",(0,i.kt)("inlineCode",{parentName:"p"},"scope_mode")," is needed. An optional ",(0,i.kt)("inlineCode",{parentName:"p"},"scope")," object can restrict pruning to readings from a specific source."),(0,i.kt)("h3",{id:"scope-configuration-optional"},"Scope Configuration (optional)"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Property"),(0,i.kt)("th",{parentName:"tr",align:null},"Required"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"source")),(0,i.kt)("td",{parentName:"tr",align:null},"No"),(0,i.kt)("td",{parentName:"tr",align:null},"When set, only readings with this source are eligible for pruning")))),(0,i.kt)("h3",{id:"basic-prune-scope-example"},"Basic Prune Scope Example"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meter_readings": [\n    {\n      "jsonataExpression": "$.readings",\n      "mode": "upsert-prune-scope",\n      "meter": {\n        "unique_ids": [{ "attribute": "external_id", "field": "meter_id" }]\n      },\n      "meter_counter": {\n        "unique_ids": [{ "attribute": "external_id", "field": "counter_id" }]\n      },\n      "fields": [\n        { "attribute": "external_id", "field": "reading_id" },\n        { "attribute": "timestamp", "field": "read_at" },\n        { "attribute": "source", "constant": "ERP" },\n        { "attribute": "value", "field": "meter_value" }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("p",null,"Upserts all readings from the ",(0,i.kt)("inlineCode",{parentName:"p"},"readings")," array, then deletes other readings for the same meter+counter not in the payload."),(0,i.kt)("h3",{id:"prune-scope-with-source-filter"},"Prune Scope with Source Filter"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "meter_readings": [\n    {\n      "jsonataExpression": "$.readings",\n      "mode": "upsert-prune-scope",\n      "scope": { "source": "ERP" },\n      "meter": {\n        "unique_ids": [{ "attribute": "external_id", "field": "meter_id" }]\n      },\n      "meter_counter": {\n        "unique_ids": [{ "attribute": "external_id", "field": "counter_id" }]\n      },\n      "fields": [\n        { "attribute": "external_id", "field": "reading_id" },\n        { "attribute": "timestamp", "field": "read_at" },\n        { "attribute": "source", "constant": "ERP" },\n        { "attribute": "value", "field": "meter_value" }\n      ]\n    }\n  ]\n}\n')),(0,i.kt)("p",null,"With ",(0,i.kt)("inlineCode",{parentName:"p"},'source: "ERP"'),", only readings with ",(0,i.kt)("inlineCode",{parentName:"p"},'source: "ERP"')," are eligible for pruning. Manually entered or ECP readings remain untouched."),(0,i.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If the payload yields zero readings, all readings in scope will be deleted \u2014 the ERP is treated as the source of truth. Use the ",(0,i.kt)("inlineCode",{parentName:"p"},"source")," scope filter to avoid accidentally deleting readings from other sources (e.g., manually entered readings)."))),(0,i.kt)("h3",{id:"important-notes"},"Important Notes"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Scope"),": The scope is always all readings for the meter + counter."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Permanent Deletion"),": Meter reading deletion is always permanent (no soft delete/purge distinction)."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Source Filter Recommended"),": Use ",(0,i.kt)("inlineCode",{parentName:"li"},"source")," to avoid accidentally deleting readings from other sources."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"External ID"),": The ",(0,i.kt)("inlineCode",{parentName:"li"},"external_id")," attribute is used to identify which readings to keep during pruning.")),(0,i.kt)("h2",{id:"best-practices"},"Best Practices"),(0,i.kt)("h3",{id:"ensure-meters-exist-first"},"Ensure Meters Exist First"),(0,i.kt)("p",null,"Process meters before readings:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "entities": [\n    {\n      "entity_schema": "meter",\n      "unique_ids": ["meter_number"],\n      "fields": [...]\n    }\n  ],\n  "meter_readings": [...]\n}\n')),(0,i.kt)("h3",{id:"use-batch-identifiers"},"Use Batch Identifiers"),(0,i.kt)("p",null,"Include batch information for traceability:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "fields": [\n    { "attribute": "batch_id", "field": "$$.batchId" },\n    { "attribute": "import_timestamp", "field": "$$.importTime" }\n  ]\n}\n')),(0,i.kt)("h3",{id:"handle-missing-readings-gracefully"},"Handle Missing Readings Gracefully"),(0,i.kt)("p",null,"Use conditional processing:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "jsonataExpression": "readings[value != null and value >= 0]"\n}\n')),(0,i.kt)("h3",{id:"validate-value-ranges"},"Validate Value Ranges"),(0,i.kt)("p",null,"Use JSONata to validate readings:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "attribute": "value",\n  "jsonataExpression": "currentReading >= 0 ? currentReading : $error(\'Negative reading value\')"\n}\n')),(0,i.kt)("h2",{id:"next-steps"},"Next Steps"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"./examples"},"Examples")," - Complete integration examples with meter readings")))}p.isMDXComponent=!0}}]);